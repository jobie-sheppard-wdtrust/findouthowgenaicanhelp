<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patient Data Guardian - Single Page</title>
    <meta
      name="description"
      content="Single-file version of the Patient Data Guardian interaction."
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              border: "hsl(var(--border) / <alpha-value>)",
              input: "hsl(var(--input) / <alpha-value>)",
              ring: "hsl(var(--ring) / <alpha-value>)",
              background: "hsl(var(--background) / <alpha-value>)",
              foreground: "hsl(var(--foreground) / <alpha-value>)",
              primary: {
                DEFAULT: "hsl(var(--primary) / <alpha-value>)",
                foreground: "hsl(var(--primary-foreground) / <alpha-value>)",
              },
              secondary: {
                DEFAULT: "hsl(var(--secondary) / <alpha-value>)",
                foreground: "hsl(var(--secondary-foreground) / <alpha-value>)",
              },
              destructive: {
                DEFAULT: "hsl(var(--destructive) / <alpha-value>)",
                foreground: "hsl(var(--destructive-foreground) / <alpha-value>)",
              },
              success: {
                DEFAULT: "hsl(var(--success) / <alpha-value>)",
                foreground: "hsl(var(--success-foreground) / <alpha-value>)",
              },
              warning: {
                DEFAULT: "hsl(var(--warning) / <alpha-value>)",
                foreground: "hsl(var(--warning-foreground) / <alpha-value>)",
              },
              muted: {
                DEFAULT: "hsl(var(--muted) / <alpha-value>)",
                foreground: "hsl(var(--muted-foreground) / <alpha-value>)",
              },
              accent: {
                DEFAULT: "hsl(var(--accent) / <alpha-value>)",
                foreground: "hsl(var(--accent-foreground) / <alpha-value>)",
              },
              popover: {
                DEFAULT: "hsl(var(--popover) / <alpha-value>)",
                foreground: "hsl(var(--popover-foreground) / <alpha-value>)",
              },
              card: {
                DEFAULT: "hsl(var(--card) / <alpha-value>)",
                foreground: "hsl(var(--card-foreground) / <alpha-value>)",
              },
              chat: {
                bot: "hsl(var(--chat-bot) / <alpha-value>)",
                "bot-foreground": "hsl(var(--chat-bot-foreground) / <alpha-value>)",
                user: "hsl(var(--chat-user) / <alpha-value>)",
                "user-foreground": "hsl(var(--chat-user-foreground) / <alpha-value>)",
              },
            },
            borderRadius: {
              lg: "var(--radius)",
              md: "calc(var(--radius) - 2px)",
              sm: "calc(var(--radius) - 4px)",
            },
            boxShadow: {
              soft: "0 2px 8px rgba(0, 0, 0, 0.08)",
              medium: "0 4px 12px rgba(0, 0, 0, 0.1)",
              elevated: "0 8px 24px rgba(0, 0, 0, 0.12)",
            },
            scale: {
              98: "0.98",
            },
          },
        },
      };
    </script>
    <style>
      :root {
        --background: 220 20% 97%;
        --foreground: 220 20% 10%;
        --card: 0 0% 100%;
        --card-foreground: 220 20% 15%;
        --popover: 0 0% 100%;
        --popover-foreground: 220 20% 10%;
        --primary: 221 83% 53%;
        --primary-foreground: 0 0% 100%;
        --secondary: 220 15% 95%;
        --secondary-foreground: 220 20% 15%;
        --muted: 220 15% 90%;
        --muted-foreground: 220 10% 50%;
        --accent: 280 60% 45%;
        --accent-foreground: 0 0% 100%;
        --destructive: 0 84% 60%;
        --destructive-foreground: 0 0% 100%;
        --success: 142 71% 45%;
        --success-foreground: 0 0% 100%;
        --warning: 38 92% 50%;
        --warning-foreground: 0 0% 100%;
        --border: 220 15% 90%;
        --input: 220 15% 90%;
        --ring: 221 83% 53%;
        --radius: 0.75rem;
        --chat-bot: 220 15% 95%;
        --chat-bot-foreground: 220 20% 15%;
        --chat-user: 221 83% 53%;
        --chat-user-foreground: 0 0% 100%;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, sans-serif;
      }

      .glass-header {
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid hsl(var(--border));
      }

      @keyframes message-in {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes highlight-sweep {
        0% {
          background-position: -100% 0;
        }
        100% {
          background-position: 200% 0;
        }
      }

      @keyframes pulse-glow {
        0%,
        100% {
          box-shadow: 0 0 0 0 hsl(var(--primary) / 0.4);
        }
        50% {
          box-shadow: 0 0 0 8px hsl(var(--primary) / 0);
        }
      }

      @keyframes slide-up {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes send-bulge {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.3);
        }
        100% {
          transform: scale(1);
        }
      }

      @keyframes thinking-pulse {
        0%,
        100% {
          opacity: 0.4;
        }
        50% {
          opacity: 1;
        }
      }

      .animate-message-in {
        animation: message-in 0.3s ease-out forwards;
      }

      .animate-slide-up {
        animation: slide-up 0.4s ease-out forwards;
      }

      .animate-pulse-glow {
        animation: pulse-glow 2s ease-in-out infinite;
      }

      .animate-send-bulge {
        animation: send-bulge 0.7s ease-in-out;
      }

      .animate-thinking {
        animation: thinking-pulse 1s ease-in-out infinite;
      }

      .text-highlight {
        background: linear-gradient(
          90deg,
          transparent 0%,
          hsl(var(--primary) / 0.3) 50%,
          transparent 100%
        );
        background-size: 200% 100%;
        animation: highlight-sweep 0.6s ease-out forwards;
      }

      .tooltip {
        position: relative;
        display: inline-flex;
      }

      .tooltip-content {
        position: absolute;
        left: 50%;
        top: calc(100% + 8px);
        transform: translateX(-50%);
        background: hsl(var(--popover));
        color: hsl(var(--popover-foreground));
        border: 1px solid hsl(var(--border));
        border-radius: 0.5rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        width: 220px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
        z-index: 20;
      }

      .tooltip:hover .tooltip-content,
      .tooltip:focus-within .tooltip-content {
        opacity: 1;
        pointer-events: auto;
      }
    </style>
  </head>
  <body class="bg-background text-foreground">
    <div class="flex flex-col h-screen">
      <header class="glass-header px-6 py-4 flex-shrink-0">
        <div class="max-w-7xl mx-auto flex items-center gap-3">
          <h1 class="text-lg font-semibold text-foreground">
            Keeping personal data anonymous
          </h1>
          <div class="tooltip">
            <button
              class="w-6 h-6 rounded-full bg-primary/10 flex items-center justify-center hover:bg-primary/20 transition-colors"
              aria-label="Learn more"
            >
              <svg
                class="w-4 h-4 text-primary"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
              </svg>
            </button>
            <div class="tooltip-content">
              Learn to protect patient data when using GenAI tools. Only share
              information that cannot be used to identify an individual.
            </div>
          </div>
        </div>
      </header>

      <main class="flex-1 flex overflow-hidden">
        <section class="w-1/2 border-r border-border bg-card/50 flex flex-col">
          <div class="p-4 border-b border-border">
            <h2 class="text-lg font-semibold text-card-foreground">GenAI Assistant</h2>
            <p class="text-sm text-muted-foreground mt-1">
              Build your referral request below
            </p>
          </div>
          <div
            class="flex-1 overflow-y-auto p-4 space-y-4"
            id="chat-messages"
          ></div>
          <div class="p-4 border-t border-border bg-gradient-to-t from-background to-transparent">
            <div
              class="relative bg-card rounded-2xl border border-border shadow-medium overflow-hidden"
            >
              <textarea
                id="prompt-input"
                class="w-full resize-none bg-transparent border-none p-4 pr-14 text-sm text-card-foreground outline-none min-h-[60px]"
                placeholder="Your prompt will appear here..."
                readonly
              ></textarea>
              <button
                id="send-button"
                class="absolute right-3 bottom-3 w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 bg-muted text-muted-foreground cursor-not-allowed"
                aria-label="Send message"
              >
                <svg
                  class="w-5 h-5"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
              </button>
            </div>
          </div>
        </section>

        <section class="w-1/2 bg-card flex flex-col">
          <div class="p-4 border-b border-border">
            <h2 class="text-lg font-semibold text-card-foreground">Patient Data</h2>
            <p class="text-sm text-muted-foreground mt-1">
              Click copy to add fields to your prompt
            </p>
          </div>
          <div class="flex-1 overflow-y-auto p-4 space-y-2" id="patient-fields"></div>
        </section>
      </main>

      <div id="feedback-modal"></div>
    </div>

    <script>
      const PATIENT_FIELDS = [
        { label: "Name", value: "L. Morgan", key: "name", isPID: true },
        { label: "Age", value: "47", key: "age", isPID: true },
        {
          label: "Address",
          value: "8 Fernbrook Close, Bristol, BS9 2LP",
          key: "address",
          isPID: true,
        },
        { label: "Nationality", value: "Scottish", key: "nationality", isPID: true },
        { label: "Ethnicity", value: "White", key: "ethnicity", isPID: true },
        {
          label: "History",
          value:
            "Intermittent palpitations for ~6 months, family history of premature coronary artery disease (first-degree relative MI <55). No known structural heart disease.",
          key: "history",
          isPID: false,
        },
        { label: "Current medication", value: "Bisoprolol 2.5 mg OD", key: "medication", isPID: false },
        { label: "Allergies", value: "None", key: "allergies", isPID: false },
        {
          label: "Investigations",
          value:
            "Recent ECG - sinus rhythm with some premature atrial complexes; thyroid tests normal.",
          key: "investigations",
          isPID: false,
        },
      ];

      const BASE_PROMPT =
        "Help me write a referral for this patient. I want to refer them to the [specialist to be decided]. Make sure the tone is kind. Here is their information:";

      const state = {
        messages: [{ id: "welcome", role: "bot", content: "How can I help?" }],
        copiedFields: new Set(),
        isAnimating: false,
        highlightedField: null,
        isGenerating: false,
        typingContent: "",
        showFeedback: false,
        isSuccess: false,
        hasSent: false,
        isSendingAnimation: false,
        isThinking: false,
        displayInputValue: BASE_PROMPT,
        lastMessageSignature: "",
      };

      const promptInput = document.getElementById("prompt-input");
      const chatMessages = document.getElementById("chat-messages");
      const patientFields = document.getElementById("patient-fields");
      const sendButton = document.getElementById("send-button");
      const feedbackModal = document.getElementById("feedback-modal");

      const resizeTextarea = () => {
        promptInput.style.height = "auto";
        promptInput.style.height = `${promptInput.scrollHeight}px`;
      };

      const buildPrompt = () => {
        if (state.copiedFields.size === 0) {
          return BASE_PROMPT;
        }
        const lines = Array.from(state.copiedFields)
          .map((key) => {
            const field = PATIENT_FIELDS.find((item) => item.key === key);
            return field ? `${field.label}: ${field.value}` : "";
          })
          .filter(Boolean)
          .join("\n");
        return `${BASE_PROMPT}\n\n${lines}`;
      };

      const generateReferral = () => {
        const getValue = (key, realValue) =>
          state.copiedFields.has(key) ? realValue : "[redacted]";

        return `Patient details\nName: ${getValue("name", "L. Morgan")}\nAge: ${getValue(
          "age",
          "47"
        )}\nAddress: ${getValue("address", "8 Fernbrook Close, Bristol, BS9 2LP")}\nNationality: ${getValue(
          "nationality",
          "Scottish"
        )}\nEthnicity: ${getValue("ethnicity", "White")}\n\nReason for referral\nRoutine cardiology assessment for intermittent palpitations and cardiovascular risk review in the context of a family history of premature coronary artery disease.\n\nRelevant background\n${getValue(
          "history",
          "Reports episodic palpitations over the past six months, self-limiting and not associated with syncope or chest pain. Family history of myocardial infarction in a first-degree relative aged under 55. No known structural heart disease."
        )}\n\nCurrent management\n${getValue(
          "medication",
          "Bisoprolol 2.5 mg once daily"
        )}. No lipid-lowering therapy currently prescribed.\n\nAllergies\n${getValue(
          "allergies",
          "No known drug allergies"
        )}.\n\nRelevant investigations\n${getValue(
          "investigations",
          "Recent ECG in primary care demonstrated sinus rhythm with occasional premature atrial complexes. Thyroid function tests within normal range"
        )}.\n\nAdditional information\nThis is a routine referral for outpatient cardiology review, submitted via eRS.\n\nKind regards\n[Referring clinician name]\n[Practice name]\n[Contact details]`;
      };

      const createIcon = (type) => {
        const icons = {
          bot: `<svg class="w-5 h-5 text-accent-foreground" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2"></rect><circle cx="12" cy="5" r="2"></circle><path d="M12 7v4"></path><line x1="8" y1="16" x2="8" y2="16"></line><line x1="16" y1="16" x2="16" y2="16"></line></svg>`,
          user: `<svg class="w-5 h-5 text-primary-foreground" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`,
          copy: `<svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`,
          check: `<svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`,
          checkCircle: `<svg class="w-10 h-10 text-success flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
          xCircle: `<svg class="w-10 h-10 text-destructive flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`,
          rotate: `<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 .49-5.94L1 10"></path></svg>`,
          arrowRight: `<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>`,
        };
        return icons[type] || "";
      };

      const renderMessages = (force = false) => {
        const signature = state.messages.map((message) => message.id).join("|");
        if (!force && signature === state.lastMessageSignature) {
          return;
        }
        state.lastMessageSignature = signature;
        chatMessages.innerHTML = "";
        state.messages.forEach((message, index) => {
          const wrapper = document.createElement("div");
          wrapper.className = `flex items-start gap-3 ${
            index === 0 ? "" : "animate-message-in"
          } ${message.role === "user" ? "flex-row-reverse" : ""}`;

          const avatar = document.createElement("div");
          avatar.className = `w-9 h-9 rounded-full flex items-center justify-center flex-shrink-0 ${
            message.role === "bot" ? "bg-accent" : "bg-primary"
          }`;
          avatar.innerHTML = message.role === "bot" ? createIcon("bot") : createIcon("user");

          const bubble = document.createElement("div");
          bubble.className = `max-w-[85%] px-4 py-3 rounded-2xl shadow-soft whitespace-pre-wrap text-sm leading-relaxed ${
            message.role === "bot"
              ? "rounded-tl-md bg-chat-bot text-chat-bot-foreground"
              : "rounded-tr-md bg-chat-user text-chat-user-foreground"
          }`;
          bubble.textContent = message.content;

          wrapper.appendChild(avatar);
          wrapper.appendChild(bubble);
          chatMessages.appendChild(wrapper);
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
      };

      const renderThinking = () => {
        const existing = document.getElementById("thinking-indicator");
        if (!state.isThinking) {
          if (existing) {
            existing.remove();
          }
          return;
        }
        if (existing) {
          return;
        }
        const thinking = document.createElement("div");
        thinking.id = "thinking-indicator";
        thinking.className = "flex items-start gap-3 animate-message-in";
        thinking.innerHTML = `
          <div class="w-9 h-9 rounded-full bg-accent flex items-center justify-center flex-shrink-0">
            ${createIcon("bot")}
          </div>
          <div class="px-4 py-3 rounded-2xl rounded-tl-md bg-chat-bot shadow-soft">
            <div class="flex gap-1.5 items-center">
              <span class="w-2 h-2 rounded-full bg-muted-foreground animate-thinking"></span>
              <span class="w-2 h-2 rounded-full bg-muted-foreground animate-thinking" style="animation-delay: 0.2s"></span>
              <span class="w-2 h-2 rounded-full bg-muted-foreground animate-thinking" style="animation-delay: 0.4s"></span>
            </div>
          </div>
        `;
        chatMessages.appendChild(thinking);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      };

      const renderTyping = () => {
        const existing = document.getElementById("typing-indicator");
        if (!state.typingContent) {
          if (existing) {
            existing.remove();
          }
          return;
        }
        const safeContent = state.typingContent.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        if (!existing) {
          const typing = document.createElement("div");
          typing.id = "typing-indicator";
          typing.className = "flex items-start gap-3 animate-message-in";
          typing.innerHTML = `
            <div class="w-9 h-9 rounded-full bg-accent flex items-center justify-center flex-shrink-0">
              ${createIcon("bot")}
            </div>
            <div class="max-w-[85%] px-4 py-3 rounded-2xl rounded-tl-md bg-chat-bot text-chat-bot-foreground shadow-soft whitespace-pre-wrap text-sm leading-relaxed"></div>
          `;
          typing.querySelector("div:last-child").innerHTML = safeContent;
          chatMessages.appendChild(typing);
        } else {
          const bubble = existing.querySelector("div:last-child");
          bubble.innerHTML = safeContent;
        }
        chatMessages.scrollTop = chatMessages.scrollHeight;
      };

      const renderFields = () => {
        patientFields.innerHTML = "";
        PATIENT_FIELDS.forEach((field) => {
          const isCopied = state.copiedFields.has(field.key);
          const isHighlighted = state.highlightedField === field.key;

          const row = document.createElement("div");
          row.className = `flex items-center gap-2 px-2 py-1.5 rounded-md border transition-all duration-300 ${
            isHighlighted
              ? "border-primary bg-primary/5 shadow-soft"
              : "border-border bg-card hover:border-muted-foreground/30"
          }`;

          const button = document.createElement("button");
          button.className = `flex-shrink-0 w-6 h-6 rounded flex items-center justify-center transition-all duration-200 ${
            isCopied
              ? "bg-success text-success-foreground cursor-not-allowed"
              : state.isAnimating || state.hasSent
              ? "bg-muted text-muted-foreground cursor-not-allowed opacity-50"
              : "bg-primary text-primary-foreground hover:bg-primary/90 active:scale-95"
          }`;
          button.disabled = state.isAnimating || isCopied || state.hasSent;
          button.setAttribute("aria-label", `Copy ${field.label}`);
          button.innerHTML = isCopied ? createIcon("check") : createIcon("copy");
          button.addEventListener("click", () => handleCopyField(field));

          const info = document.createElement("div");
          info.className = "flex-1 min-w-0 flex items-baseline gap-2";

          const label = document.createElement("span");
          label.className =
            "text-xs font-medium text-muted-foreground uppercase tracking-wide flex-shrink-0";
          label.textContent = `${field.label}:`;

          const value = document.createElement("p");
          value.className = `text-sm text-card-foreground break-words transition-all duration-300 ${
            isHighlighted ? "text-highlight rounded px-1 -mx-1" : ""
          }`;
          value.textContent = field.value;

          info.appendChild(label);
          info.appendChild(value);

          row.appendChild(button);
          row.appendChild(info);
          patientFields.appendChild(row);
        });
      };

      const renderInput = () => {
        promptInput.value = state.displayInputValue;
        resizeTextarea();
      };

      const renderSendButton = () => {
        const canSend = state.copiedFields.size > 0 && !state.hasSent;
        sendButton.disabled = !canSend || state.isGenerating || state.isSendingAnimation;
        sendButton.className = `absolute right-3 bottom-3 w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 ${
          state.isSendingAnimation ? "animate-send-bulge" : ""
        } ${
          canSend && !state.isGenerating && !state.isSendingAnimation
            ? "bg-primary text-primary-foreground hover:bg-primary/90 active:scale-95 animate-pulse-glow"
            : "bg-muted text-muted-foreground cursor-not-allowed"
        }`;
      };

      const renderFeedbackModal = () => {
        if (!state.showFeedback) {
          feedbackModal.innerHTML = "";
          return;
        }

        const content = `
          <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-foreground/50 backdrop-blur-sm animate-slide-up">
            <div class="w-full max-w-lg bg-card rounded-2xl shadow-elevated overflow-hidden ${
              state.isSuccess ? "border-2 border-success" : "border-2 border-destructive"
            }">
              <div class="p-6 flex items-center gap-4 ${
                state.isSuccess ? "bg-success/10" : "bg-destructive/10"
              }">
                ${state.isSuccess ? createIcon("checkCircle") : createIcon("xCircle")}
                <div>
                  <h3 class="text-xl font-bold text-card-foreground">
                    ${state.isSuccess ? "Excellent work!" : "Not quite right"}
                  </h3>
                  <p class="text-sm text-muted-foreground mt-1">
                    ${
                      state.isSuccess
                        ? "You've protected the patient's identity"
                        : "The patient's data is at risk"
                    }
                  </p>
                </div>
              </div>
              <div class="p-6 text-sm text-card-foreground leading-relaxed">
                ${
                  state.isSuccess
                    ? `<p>
                        That's what being a <strong>Human In The Loop</strong> is all about!
                        You removed all of the patient's PID (Personally Identifiable Data),
                        and only included their symptoms. This means that if the GenAI tool
                        stored their data, or sells it to a third party, the medical records
                        could not be linked to any part of their personal identity. This keeps
                        them anonymous and <strong>complies with GDPR</strong>.
                      </p>`
                    : `<p class="mb-4">
                        As well as the patient's symptoms, you've included PID in the prompt.
                        This is <strong>dangerous</strong> â€“ a GenAI company might view this
                        conversation, store the data, and sell it to third parties. Even just
                        one of these pieces of PID could be enough for the patient's identity
                        to be linked to their medical records. That would be a
                        <strong>GDPR violation</strong> and very emotionally distressing for
                        the patient.
                      </p>
                      <p class="p-4 bg-warning/10 rounded-lg border border-warning/30">
                        <strong>Remember:</strong> Notice how the GenAI didn't stop you?
                        It's important to remember that <em>you</em> are responsible for
                        how you use it, as the human in the loop. You cannot trust GenAI
                        to tell you when a use case is legal or appropriate.
                      </p>`
                }
              </div>
              <div class="p-6 pt-0 flex gap-3">
                <button
                  id="feedback-retry"
                  class="flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-xl border border-border bg-secondary text-secondary-foreground font-medium transition-all hover:bg-muted active:scale-98"
                >
                  ${createIcon("rotate")}
                  Retry
                </button>
                <button
                  id="feedback-finish"
                  class="flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-xl font-medium transition-all active:scale-98 ${
                    state.isSuccess
                      ? "bg-success text-success-foreground hover:bg-success/90"
                      : "bg-primary text-primary-foreground hover:bg-primary/90"
                  }"
                >
                  Finish
                  ${createIcon("arrowRight")}
                </button>
              </div>
            </div>
          </div>
        `;

        feedbackModal.innerHTML = content;
        document
          .getElementById("feedback-retry")
          .addEventListener("click", handleRetry);
        document
          .getElementById("feedback-finish")
          .addEventListener("click", handleFinish);
      };

      const renderAll = () => {
        renderMessages();
        renderThinking();
        renderTyping();
        renderFields();
        renderInput();
        renderSendButton();
        renderFeedbackModal();
      };

      const updateDisplayInputValue = () => {
        if (!state.hasSent) {
          state.displayInputValue = buildPrompt();
          renderInput();
          renderSendButton();
        }
      };

      const handleCopyField = (field) => {
        if (state.copiedFields.has(field.key) || state.isAnimating || state.hasSent) {
          return;
        }

        state.isAnimating = true;
        state.highlightedField = field.key;
        renderFields();

        setTimeout(() => {
          state.copiedFields.add(field.key);
          state.highlightedField = null;
          state.isAnimating = false;
          updateDisplayInputValue();
          renderFields();
          renderSendButton();
        }, 600);
      };

      const handleSend = () => {
        if (
          state.copiedFields.size === 0 ||
          state.isGenerating ||
          state.hasSent ||
          state.isSendingAnimation
        ) {
          return;
        }

        const requiredMedicalFields = ["history", "medication", "allergies", "investigations"];
        const missingMedicalFields = requiredMedicalFields.filter(
          (key) => !state.copiedFields.has(key)
        );

        if (missingMedicalFields.length > 0) {
          state.messages.push({
            id: `user-${Date.now()}`,
            role: "user",
            content: buildPrompt(),
          });
          state.isThinking = true;
          renderMessages(true);
          renderThinking();

          setTimeout(() => {
            state.isThinking = false;
            renderThinking();
            const errorMessage =
              "Oops! You've asked me to write a referral but you haven't included all of the medical information I need. Could you paste it in, and then I can write a referral for you?";
            const chars = errorMessage.split("");
            let charIndex = 0;
            state.typingContent = "";
            const totalDuration = (errorMessage.split(/(\s+)/).length / 16) * 1000;
            const charInterval = totalDuration / chars.length;
            const typeInterval = setInterval(() => {
              if (charIndex < chars.length) {
                state.typingContent += chars[charIndex];
                charIndex += 1;
                renderTyping();
              } else {
                clearInterval(typeInterval);
                state.messages.push({
                  id: `bot-error-${Date.now()}`,
                  role: "bot",
                  content: errorMessage,
                });
                state.typingContent = "";
                state.copiedFields = new Set();
                state.displayInputValue = BASE_PROMPT;
                renderAll();
              }
            }, charInterval);
          }, 800);
          return;
        }

        state.isSendingAnimation = true;
        renderSendButton();

        setTimeout(() => {
          state.isSendingAnimation = false;
          state.hasSent = true;

          state.messages.push({
            id: `user-${Date.now()}`,
            role: "user",
            content: buildPrompt(),
          });

          state.displayInputValue = "";
          state.isThinking = true;
          state.isGenerating = true;
          renderAll();

          const fullReferral = generateReferral();
          const words = fullReferral.split(/(\s+)/);

          setTimeout(() => {
            state.isThinking = false;
            renderThinking();

            const chars = fullReferral.split("");
            let charIndex = 0;
            const totalDuration = (words.length / 16) * 1000;
            const charInterval = totalDuration / chars.length;

            const typeInterval = setInterval(() => {
              if (charIndex < chars.length) {
                state.typingContent += chars[charIndex];
                charIndex += 1;
                renderTyping();
              } else {
                clearInterval(typeInterval);
                state.isGenerating = false;
                state.messages.push({
                  id: `bot-${Date.now()}`,
                  role: "bot",
                  content: fullReferral,
                });
                state.typingContent = "";

                const pidFields = ["name", "age", "address", "nationality", "ethnicity"];
                const includedPID = pidFields.some((key) => state.copiedFields.has(key));
                state.isSuccess = !includedPID;

                setTimeout(() => {
                  state.showFeedback = true;
                  renderFeedbackModal();
                }, 500);

                renderAll();
              }
            }, charInterval);
          }, 2000);
        }, 700);
      };

      const handleRetry = () => {
        state.messages = [{ id: "welcome", role: "bot", content: "How can I help?" }];
        state.copiedFields = new Set();
        state.isAnimating = false;
        state.highlightedField = null;
        state.isGenerating = false;
        state.typingContent = "";
        state.showFeedback = false;
        state.isSuccess = false;
        state.hasSent = false;
        state.isSendingAnimation = false;
        state.isThinking = false;
        state.displayInputValue = BASE_PROMPT;
        renderAll();
      };

      const handleFinish = () => {
        state.showFeedback = false;
        renderFeedbackModal();
        alert("Great job! Continue to the next section of the module.");
      };

      sendButton.addEventListener("click", handleSend);

      renderAll();
    </script>
  </body>
</html>
