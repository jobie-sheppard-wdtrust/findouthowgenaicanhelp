<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GenAI Chatbot</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --background: hsl(220 20% 97%);
      --foreground: hsl(220 20% 10%);
      --card: hsl(0 0% 100%);
      --border: hsl(220 15% 90%);
      --primary: hsl(221 83% 53%);
      --primary-foreground: hsl(0 0% 100%);
      --muted-foreground: hsl(220 10% 50%);
      --chat-bot: hsl(220 15% 95%);
      --chat-bot-foreground: hsl(220 20% 15%);
      --chat-user: hsl(221 83% 53%);
      --chat-user-foreground: hsl(0 0% 100%);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--background);
      color: var(--foreground);
      line-height: 1.5;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      flex-shrink: 0;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(8px);
    }

    header .inner {
      max-width: 48rem;
      margin: 0 auto;
    }

    header h1 {
      font-size: 1.125rem;
      font-weight: 600;
    }

    header p {
      font-size: 0.875rem;
      color: var(--muted-foreground);
    }

    main {
      flex: 1;
      overflow-y: auto;
      scroll-behavior: auto;
      padding: 1.5rem 1rem;
    }

    .messages {
      width: 100%;
      max-width: 48rem;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .message {
      width: 100%;
      min-width: 0;
      display: flex;
      gap: 0.75rem;
      align-items: flex-start;
      opacity: 0;
      transform: translateY(10px);
      animation: messageIn 0.3s ease-out forwards;
    }

    .message.no-animate {
      opacity: 1;
      transform: translateY(0);
      animation: none;
    }

    .message.user {
      justify-content: flex-end;
    }

    .message.bot {
      justify-content: flex-start;
    }

    .avatar {
      flex-shrink: 0;
      width: 2.25rem;
      height: 2.25rem;
      border-radius: 50%;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .avatar svg {
      width: 1.25rem;
      height: 1.25rem;
      fill: none;
      stroke: var(--primary-foreground);
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .bubble {
      flex: 0 1 auto;
      display: inline-flex;
      width: max-content;
      max-width: 32rem;
      min-width: 0;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      font-size: 0.9375rem;
      white-space: pre-wrap;
      word-wrap: break-word;
      word-break: break-word;
      overflow-wrap: break-word;
    }


    .message.bot .bubble {
      background: var(--chat-bot);
      color: var(--chat-bot-foreground);
      border-top-left-radius: 0.375rem;
    }

    .message.user .bubble {
      background: var(--chat-user);
      color: var(--chat-user-foreground);
      border-top-right-radius: 0.375rem;
    }

    .typing-indicator {
      display: flex;
      gap: 0.75rem;
      align-items: flex-start;
    }

    .typing-dots {
      display: flex;
      gap: 0.25rem;
      padding: 1rem;
      background: var(--chat-bot);
      border-radius: 1rem;
      border-top-left-radius: 0.375rem;
    }

    .typing-dots span {
      width: 0.5rem;
      height: 0.5rem;
      background: var(--muted-foreground);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }

    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
    .typing-dots span:nth-child(3) { animation-delay: 0s; }

    footer {
      flex-shrink: 0;
      padding: 0.5rem 1rem 1.5rem;
      background: linear-gradient(to top, var(--background), var(--background), transparent);
    }

    footer .inner {
      max-width: 48rem;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .prompts {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      animation: fadeIn 0.3s ease-out;
    }

    .prompt-btn {
      padding: 0.5rem 1rem;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 9999px;
      font-size: 0.875rem;
      color: var(--foreground);
      cursor: pointer;
      transition: all 0.2s;
    }

    .prompt-btn:hover {
      background: var(--primary);
      color: var(--primary-foreground);
      border-color: var(--primary);
    }

    .prompt-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .input-wrapper {
      position: relative;
      background: var(--card);
      border-radius: 1rem;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    textarea {
      width: 100%;
      resize: none;
      background: transparent;
      border: none;
      padding: 1rem 1.25rem;
      padding-right: 3.5rem;
      font-size: 0.9375rem;
      font-family: inherit;
      color: var(--foreground);
      outline: none;
      min-height: 56px;
      max-height: 200px;
    }

    textarea::placeholder {
      color: var(--muted-foreground);
    }

    textarea.text-fade-in {
      animation: textFadeIn 0.4s ease-out;
    }

    .send-btn {
      position: absolute;
      right: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 0.75rem;
      background: var(--primary);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .send-btn:hover {
      opacity: 0.9;
    }

    .send-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .send-btn.bulge {
      animation: buttonBulge 0.3s ease-out;
    }

    .send-btn svg {
      width: 1.25rem;
      height: 1.25rem;
      stroke: var(--primary-foreground);
      stroke-width: 2;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    @keyframes messageIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    @keyframes textFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes buttonBulge {
      0% { transform: translateY(-50%) scale(1); }
      50% { transform: translateY(-50%) scale(1.15); }
      100% { transform: translateY(-50%) scale(1); }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="inner">
        <h1>GenAI Chatbot</h1>
        <p>See some examples of the help it can provide</p>
      </div>
    </header>

    <main>
      <div class="messages" id="messages"></div>
    </main>

    <footer>
      <div class="inner">
        <div class="prompts" id="prompts"></div>
        <div class="input-wrapper">
          <textarea id="input" placeholder="Type your message..." rows="1"></textarea>
          <button class="send-btn" id="sendBtn" disabled>
            <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
          </button>
        </div>
      </div>
    </footer>
  </div>

  <script>
    const PRESET_PROMPTS = [
      {
        label: "Research NICE recommendations",
        prompt: "Research the current NICE recommendations for initial management of Sepsis in adults",
        response: `Sure thing! Based on this article, NICE recommends that initial management of suspected sepsis in adults focuses on rapid recognition, prompt assessment, and early escalation. This includes using a structured risk assessment to identify people at high risk, urgent clinical review, early measurement of vital signs, blood tests (including lactate where indicated), and prompt administration of appropriate antibiotics and intravenous fluids where sepsis is suspected. Ongoing monitoring and timely referral to senior clinicians or critical care are emphasised. Would you like me to suggest how this guidance applies to a specific patient or outline the most appropriate next clinical step for them?`
      },
      {
        label: "Draft a response to this complaint",
        prompt: "Help me respond to this very sensitive complaint from a bereaved patient, regarding end-of-life care decisions. The response should acknowledge mistakes in communication, and apologise in a way that is polite and genuine",
        response: `Sure thing I can help draft a calm, compassionate response that acknowledges the communication issues without being defensive.

Dear Mrs Patel,

Thank you for taking the time to write to us, and for sharing your concerns following your husband's care. I am very sorry for your loss, and I recognise how difficult it may have been to raise these issues.

I would like to sincerely apologise for the distress caused by how end-of-life care decisions were communicated to you and your family. On reflection, it is clear that we did not explain the situation as clearly or as sensitively as we should have, and I am sorry for the additional upset this caused at an already painful time.

Your feedback highlights the importance of clear, compassionate communication, particularly when discussing complex and emotionally challenging decisions. We are reviewing this aspect of our practice to ensure families feel better informed and supported in the future.

Thank you again for bringing this to our attention. If you would like to discuss this further, or if there is anything else we can do to support you, please let us know.

With sincere condolences,
Your Name

If you like, I can make this more formal or more conversational, or I could remove anything that sounds like an admission of liability?`
      },
      {
        label: "What are arguments for and against this plan?",
        prompt: "I'm reviewing follow-up arrangements for a stable long-term condition patient. We're considering switching routine follow-ups from face-to-face to phone or video. Can you outline some practical arguments for and against this? Keep your answer concise.",
        response: `Sure thing! Let's consider some reasons for and against it.

Possible advantages
• Easier access for patients who work, travel, or have mobility issues
• Fewer missed appointments
• Saves clinic space and time
• Can feel more convenient and less stressful for some patients

Possible downsides
• You lose non-verbal cues and in-room context
• Some patients may struggle with technology or privacy
• Harder to pick up subtle deterioration or safeguarding concerns
• Continuity can suffer if different clinicians handle calls

Would you like me to turn this into a suitability checklist for remote follow-ups, or tailor this to a patient's specific condition?`
      }
    ];

    let messages = [];
    let usedPrompts = new Set();
    let isTyping = false;
    let promptsLocked = false;

    const messagesEl = document.getElementById('messages');
    const promptsEl = document.getElementById('prompts');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');

    // Bot icon SVG
    const botIconSVG = `<svg viewBox="0 0 24 24"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>`;

    function scrollToBottom() {
      const scroller = document.querySelector('main');
      if (!scroller) return;
      scroller.scrollTop = scroller.scrollHeight;
    }

    function escapeHTML(str = '') {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function renderMessages(updateOnly = false) {
      if (updateOnly && messages.length > 0) {
        // Update only the last message's text node (avoid restarting animations)
        const lastMsgIndex = messages.length - 1;
        const lastMsg = messages[lastMsgIndex];
        const lastWrap = document.getElementById(`msg-${lastMsgIndex}`);

        if (lastWrap) {
          const lastMsgEl = lastWrap.querySelector('.content');
          if (lastMsgEl) {
            lastMsgEl.textContent = lastMsg.displayContent || lastMsg.content;
          }

          scrollToBottom();
          return;
        }
      }

      messagesEl.innerHTML = messages
        .map((msg, i) => {
          const isBot = msg.role === 'bot';
          const showCursor = msg.isTyping;
          const safeText = escapeHTML(msg.displayContent || msg.content);
          return `
            <div class="message ${msg.role} ${msg.noAnimate || msg.hasRendered ? 'no-animate' : ''}" id="msg-${i}" data-msg-index="${i}">
              ${isBot ? `<div class="avatar">${botIconSVG}</div>` : ''}
              <div class="bubble">
                <span class="content">${safeText}</span>
              </div>
            </div>
          `;
        })
        .join('');

      messages.forEach((msg) => {
        msg.hasRendered = true;
      });

      if (isTyping) {
        messagesEl.innerHTML += `
          <div class="typing-indicator">
            <div class="avatar">${botIconSVG}</div>
            <div class="typing-dots">
              <span></span><span></span><span></span>
            </div>
          </div>
        `;
      }

      scrollToBottom();
    }


    function renderPrompts() {
      const available = PRESET_PROMPTS.filter((_, i) => !usedPrompts.has(i));
      if (available.length === 0 || isTyping || promptsLocked) {
        promptsEl.style.display = 'none';
        return;
      }
      promptsEl.style.display = 'flex';
      promptsEl.innerHTML = PRESET_PROMPTS.map((p, i) => {
        if (usedPrompts.has(i)) return '';
        return `<button class="prompt-btn" data-index="${i}" ${isTyping ? 'disabled' : ''}>${p.label}</button>`;
      }).join('');
    }

    function typeText(msgIndex, text, speed, callback) {
      let i = 0;
      messages[msgIndex].displayContent = '';
      messages[msgIndex].isTyping = true;
      
      // Initial render to create the message element
      renderMessages(false);
      
      function typeNext() {
        if (i < text.length) {
          messages[msgIndex].displayContent = text.slice(0, i + 1);
          i++;
          renderMessages(true); // Update only, don't re-render
          setTimeout(typeNext, speed);
        } else {
          messages[msgIndex].isTyping = false;
          renderMessages(true); // Final update
          if (callback) callback();
        }
      }
      typeNext();
    }

    function addMessage(role, content, skipTyping = false, onComplete) {
      const msg = {
        role,
        content,
        displayContent: skipTyping ? content : '',
        noAnimate: false,
        hasRendered: false
      };
      messages.push(msg);
      
      if (skipTyping) {
        renderMessages();
        if (onComplete) onComplete();
      } else {
        const speed = role === 'bot' ? 16 : 10;
        renderMessages();
        typeText(messages.length - 1, content, speed, onComplete);
      }
    }

    function sendMessage(prompt, response, skipUserTyping = false) {
      promptsLocked = true;
      inputEl.disabled = true;
      renderPrompts();
      addMessage('user', prompt, skipUserTyping);
      inputEl.value = '';
      inputEl.style.height = 'auto';
      updateSendBtn();
      
      isTyping = true;
      renderPrompts();
      renderMessages();

      const delay = skipUserTyping ? 1000 : 1500;
      setTimeout(() => {
        isTyping = false;
        addMessage('bot', response, false, () => {
          promptsLocked = false;
          inputEl.disabled = false;
          renderPrompts();
        });
      }, delay);
    }

    function handlePresetClick(index) {
      const preset = PRESET_PROMPTS[index];
      usedPrompts.add(index);
      renderPrompts();

      // Step 1: Fade in text
      inputEl.value = preset.prompt;
      inputEl.classList.add('text-fade-in');
      inputEl.style.height = 'auto';
      inputEl.style.height = Math.min(inputEl.scrollHeight, 200) + 'px';
      updateSendBtn();

      // Step 2: After 1.4s, bulge button
      setTimeout(() => {
        inputEl.classList.remove('text-fade-in');
        sendBtn.classList.add('bulge');

        // Step 3: After bulge, send
        setTimeout(() => {
          sendBtn.classList.remove('bulge');
          sendMessage(preset.prompt, preset.response, true);
        }, 300);
      }, 1400);
    }

    function updateSendBtn() {
      sendBtn.disabled = !inputEl.value.trim() || isTyping;
    }

    // Event listeners
    inputEl.addEventListener('input', () => {
      inputEl.style.height = 'auto';
      inputEl.style.height = Math.min(inputEl.scrollHeight, 200) + 'px';
      updateSendBtn();
    });

    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (inputEl.value.trim() && !isTyping) {
          const match = PRESET_PROMPTS.find(p => p.prompt.toLowerCase() === inputEl.value.toLowerCase());
          const response = match ? match.response : "Because I am just a realistic simulation of a GenAI, I can only answer the preset prompts you see on screen. If you were speaking to a full GenAI chatbot, it would answer your specific question here";
          sendMessage(inputEl.value, response, false);
        }
      }
    });

    sendBtn.addEventListener('click', () => {
      if (inputEl.value.trim() && !isTyping) {
        const match = PRESET_PROMPTS.find(p => p.prompt.toLowerCase() === inputEl.value.toLowerCase());
        const response = match ? match.response : "Because I am just a realistic simulation of a GenAI, I can only answer the preset prompts you see on screen. If you were speaking to a full GenAI chatbot, it would answer your specific question here";
        sendMessage(inputEl.value, response, false);
      }
    });

    promptsEl.addEventListener('click', (e) => {
      if (e.target.classList.contains('prompt-btn')) {
        const index = parseInt(e.target.dataset.index);
        handlePresetClick(index);
      }
    });

    // Initialize
    messages.push({ role: 'bot', content: 'How can I help?', displayContent: 'How can I help?', noAnimate: true });
    renderMessages();
    renderPrompts();
  </script>
</body>
</html>
